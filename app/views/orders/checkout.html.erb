<div class="container">
  <%= render 'layouts/navbar' %>
  <div class="row">
    <div class="col-lg-12">
      <h1>Checkout</h1>

      <% if !flash[:error].nil? %>
        <div class= "alert alert-danger" role="alert"><%= flash[:error] %></div>
      <% end %>

        <% if @cart_items.nil? %>
          You don't have any items in your cart! You must add products before you can checkout.
        <% elsif @products.nil? %>
          It looks like all the products that were in your cart are sold out! You must add in-stock products before you can checkout.
        <% else %>
          <table class="table table-hover">
            <tr class="active">
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Subtotal</th>
            </tr>
            <% if !@cart_items.nil? %>
              <% @cart_items.each do |product, quantity| %>
                <% product = Product.find(product.to_i) %>
                <tr>
                  <td><%= product.name %></td>
                  <td><%= quantity %></td>
                  <td><%= number_to_currency(product.price) %></td>
                  <td><%= number_to_currency(product.price * quantity) %></td>
              <% end %>
            <% end %>
                </tr>
          </table>

        <h4>Total: <%= number_to_currency(@order_total) %></h4>

      <h3>Payment Details:</h3>
        <%= form_for @order, url: checkout_path do |f| %>

          <% if @order.errors.any? %>
            <ul>
              <% @order.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          <% end %>

          <div class="form-group">
            <%= f.label :name %>
            <%= f.text_field :name, class: "form-control", :required => true %>
            <%= f.label :email%>
            <%= f.email_field :email, class: "form-control", :required => true %>
            <%= f.label :street, "Street Address" %>
            <%= f.text_field :street, class: "form-control", :required => true %>
            <%= f.label :city %>
            <%= f.text_field :city, class: "form-control", :required => true %>
            <%= f.label :state %>
            <%= f.text_field :state, class: "form-control", :required => true %>
            <%= f.label :zip %>
            <%= f.number_field :zip, class: "form-control", :required => true %>
            <%= f.label :cc_num, "Credit Card Number" %>
            <%= f.number_field :cc_num, class: "form-control", :required => true %>
            <%= f.label :cc_exp, "Credit Card Expiration" %>
            <%= f.date_field :cc_exp, class: "form-control", :required => true %>
            <%= f.label :sec_code, "Security Code" %>
            <%= f.number_field :sec_code, class: "form-control", :required => true %>
            <%= f.label :bill_zip, "Credit Card Zip" %>
            <%= f.number_field :bill_zip, class: "form-control", :required => true %>
            <%= f.hidden_field :purchase_time, value: Time.now %>
            <%= f.hidden_field :status, value: "Pending" %>
            <br />
            <%= f.submit "Place Order", class: "btn btn-primary" %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
